// ============================================================
// MultiGest — Schema do Banco de Dados
// Sistema de Gestão Integrada para Aluguel de Containers
// e Módulos Habitacionais
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// M1 — CORE
// ============================================================

model Company {
  id                 String   @id @default(uuid())
  cnpj               String   @unique
  razaoSocial        String   @map("razao_social")
  nomeFantasia       String?  @map("nome_fantasia")
  inscricaoEstadual  String?  @map("inscricao_estadual")
  inscricaoMunicipal String?  @map("inscricao_municipal")
  phone              String?
  email              String?
  street             String?
  number             String?
  complement         String?
  neighborhood       String?
  city               String?
  state              String?
  zipCode            String?  @map("zip_code")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  users          UserCompany[]
  customers      Customer[]
  suppliers      Supplier[]
  assets         Asset[]
  vehicles       Vehicle[]
  drivers        Driver[]
  contracts      Contract[]
  invoices       Invoice[]
  biddings       Bidding[]
  auditLogs      AuditLog[]
  stockLocations StockLocation[]
  proposals      Proposal[]
  serviceOrders  ServiceOrder[]

  @@map("companies")
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         UserRole  @default(OPERATOR)
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  companies        UserCompany[]
  auditLogs        AuditLog[]
  collectionActions CollectionAction[]
  transportOrders  TransportOrder[]

  @@map("users")
}

model UserCompany {
  id        String @id @default(uuid())
  userId    String @map("user_id")
  companyId String @map("company_id")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("user_companies")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  FINANCIAL
  READONLY
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  companyId String?  @map("company_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  oldValues Json?    @map("old_values")
  newValues Json?    @map("new_values")
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  user    User?    @relation(fields: [userId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================
// M2 — CADASTROS
// ============================================================

model Customer {
  id                 String     @id @default(uuid())
  companyId          String     @map("company_id")
  code               String?
  type               PersonType @default(JURIDICA)
  cpfCnpj            String     @map("cpf_cnpj")
  razaoSocial        String     @map("razao_social")
  nomeFantasia       String?    @map("nome_fantasia")
  inscricaoEstadual  String?    @map("inscricao_estadual")
  inscricaoMunicipal String?    @map("inscricao_municipal")
  segment            String?
  notes              String?
  isDefaulter        Boolean    @default(false) @map("is_defaulter")
  isActive           Boolean    @default(true) @map("is_active")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")
  deletedAt          DateTime?  @map("deleted_at")

  company          Company           @relation(fields: [companyId], references: [id])
  addresses        Address[]         @relation("CustomerAddresses")
  contacts         Contact[]         @relation("CustomerContacts")
  contracts        Contract[]
  invoices         Invoice[]
  defaulterRecords DefaulterRecord[]
  stockLocations   StockLocation[]   // Cliente é também um local de estoque
  proposals        Proposal[]

  @@unique([companyId, cpfCnpj])
  @@index([companyId])
  @@index([razaoSocial])
  @@map("customers")
}

model Supplier {
  id                 String     @id @default(uuid())
  companyId          String     @map("company_id")
  code               String?
  type               PersonType @default(JURIDICA)
  cpfCnpj            String     @map("cpf_cnpj")
  razaoSocial        String     @map("razao_social")
  nomeFantasia       String?    @map("nome_fantasia")
  category           String?
  notes              String?
  isActive           Boolean    @default(true) @map("is_active")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")
  deletedAt          DateTime?  @map("deleted_at")

  company             Company              @relation(fields: [companyId], references: [id])
  addresses           Address[]            @relation("SupplierAddresses")
  contacts            Contact[]            @relation("SupplierContacts")
  assetMaintenances   AssetMaintenance[]
  vehicleMaintenances VehicleMaintenance[]

  @@unique([companyId, cpfCnpj])
  @@index([companyId])
  @@map("suppliers")
}

enum PersonType {
  FISICA
  JURIDICA
}

model Address {
  id           String  @id @default(uuid())
  street       String
  number       String?
  complement   String?
  neighborhood String?
  city         String
  state        String
  zipCode      String? @map("zip_code")
  label        String?
  isMain       Boolean @default(false) @map("is_main")

  customerId String?   @map("customer_id")
  supplierId String?   @map("supplier_id")
  customer   Customer? @relation("CustomerAddresses", fields: [customerId], references: [id], onDelete: Cascade)
  supplier   Supplier? @relation("SupplierAddresses", fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model Contact {
  id        String  @id @default(uuid())
  name      String
  role      String?
  phone     String?
  cellphone String?
  email     String?
  isMain    Boolean @default(false) @map("is_main")

  customerId String?   @map("customer_id")
  supplierId String?   @map("supplier_id")
  customer   Customer? @relation("CustomerContacts", fields: [customerId], references: [id], onDelete: Cascade)
  supplier   Supplier? @relation("SupplierContacts", fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

// ============================================================
// M4 — ATIVOS
// ============================================================

model AssetType {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true) @map("is_active")

  assets Asset[]

  @@map("asset_types")
}

model Asset {
  id                  String         @id @default(uuid())
  companyId           String         @map("company_id")
  assetTypeId         String         @map("asset_type_id")
  code                String
  serialNumber        String?        @map("serial_number")
  manufacturingYear   Int?           @map("manufacturing_year")
  manufacturer        String?
  width               Decimal?       @db.Decimal(10, 2)
  height              Decimal?       @db.Decimal(10, 2)
  length              Decimal?       @db.Decimal(10, 2)
  condition           AssetCondition @default(GOOD)
  status              AssetStatus    @default(AVAILABLE)
  currentLocation     String?        @map("current_location")
  currentLocationId   String?        @map("current_location_id")
  dailyRate           Decimal?       @db.Decimal(12, 2) @map("daily_rate")
  notes               String?
  isActive            Boolean        @default(true) @map("is_active")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")
  deletedAt           DateTime?      @map("deleted_at")

  company              Company              @relation(fields: [companyId], references: [id])
  assetType            AssetType            @relation(fields: [assetTypeId], references: [id])
  currentStockLocation StockLocation?       @relation("CurrentLocation", fields: [currentLocationId], references: [id])
  statusHistory        AssetStatusHistory[]
  maintenances         AssetMaintenance[]
  contractItems        ContractItem[]
  transportOrders      TransportOrder[]
  locationHistory      AssetLocationHistory[]

  @@unique([companyId, code])
  @@index([companyId])
  @@index([status])
  @@map("assets")
}

enum AssetStatus {
  AVAILABLE
  RENTED
  IN_MAINTENANCE
  IN_TRANSIT
  DECOMMISSIONED
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

model AssetStatusHistory {
  id         String       @id @default(uuid())
  assetId    String       @map("asset_id")
  fromStatus AssetStatus? @map("from_status")
  toStatus   AssetStatus  @map("to_status")
  reason     String?
  changedBy  String?      @map("changed_by")
  createdAt  DateTime     @default(now()) @map("created_at")

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@map("asset_status_history")
}

model AssetMaintenance {
  id          String          @id @default(uuid())
  assetId     String          @map("asset_id")
  supplierId  String?         @map("supplier_id")
  type        MaintenanceType @default(CORRECTIVE)
  description String
  cost        Decimal?        @db.Decimal(12, 2)
  startDate   DateTime        @map("start_date")
  endDate     DateTime?       @map("end_date")
  notes       String?
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  asset    Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@index([assetId])
  @@map("asset_maintenances")
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
}

// ============================================================
// LOCAIS DE ESTOQUE
// O cliente também é um local de estoque, permitindo rastrear
// por onde o container passou com datas
// ============================================================

model StockLocation {
  id         String   @id @default(uuid())
  companyId  String   @map("company_id")
  name       String
  address    String?
  customerId String?  @map("customer_id") // Se o local é um cliente
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  company    Company   @relation(fields: [companyId], references: [id])
  customer   Customer? @relation(fields: [customerId], references: [id])

  assetsHere    Asset[]                @relation("CurrentLocation")
  movementsFrom AssetLocationHistory[] @relation("FromLocation")
  movementsTo   AssetLocationHistory[] @relation("ToLocation")

  @@index([companyId])
  @@map("stock_locations")
}

// Histórico de movimentação de containers entre locais
// Permite ver por onde o container passou com datas
model AssetLocationHistory {
  id              String       @id @default(uuid())
  assetId         String       @map("asset_id")
  fromLocationId  String?      @map("from_location_id")
  toLocationId    String       @map("to_location_id")
  movementDate    DateTime     @map("movement_date")
  movementType    MovementType @map("movement_type")
  notes           String?
  createdBy       String?      @map("created_by")
  createdAt       DateTime     @default(now()) @map("created_at")

  asset        Asset          @relation(fields: [assetId], references: [id])
  fromLocation StockLocation? @relation("FromLocation", fields: [fromLocationId], references: [id])
  toLocation   StockLocation  @relation("ToLocation", fields: [toLocationId], references: [id])

  @@index([assetId])
  @@map("asset_location_history")
}

// ============================================================
// M3 — CONTRATOS
// ============================================================

model Contract {
  id                String         @id @default(uuid())
  companyId         String         @map("company_id")
  customerId        String         @map("customer_id")
  contractNumber    String         @map("contract_number")
  type              ContractType   @default(MEDICAO)
  status            ContractStatus @default(DRAFT)
  startDate         DateTime       @map("start_date")
  endDate           DateTime?      @map("end_date")
  paymentTerms      String?        @map("payment_terms")
  paymentMethod     String?        @map("payment_method")
  notes             String?
  totalMonthlyValue Decimal?       @db.Decimal(14, 2) @map("total_monthly_value")
  contractSignedAt  DateTime?      @map("contract_signed_at") // Data assinatura (D4)
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  deletedAt         DateTime?      @map("deleted_at")

  company      Company            @relation(fields: [companyId], references: [id])
  customer     Customer           @relation(fields: [customerId], references: [id])
  items        ContractItem[]
  analyses     ContractAnalysis[]
  supplyOrders SupplyOrder[]
  serviceOrders ServiceOrder[]
  addendums    ContractAddendum[]
  measurements Measurement[]
  movements    ContractMovement[]
  invoices     Invoice[]

  @@unique([companyId, contractNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("contracts")
}

// Tipo de contrato:
// ANTECIPADO = Faturamento antecipado (paga antes)
// MEDICAO = Faturamento por medição (dias de uso)
// AUTOMATICO = Faturamento automático mensal
enum ContractType {
  ANTECIPADO
  MEDICAO
  AUTOMATICO
}

enum ContractStatus {
  DRAFT
  ACTIVE
  SUSPENDED
  TERMINATED
  CANCELLED
}

model ContractItem {
  id                   String    @id @default(uuid())
  contractId           String    @map("contract_id")
  assetId              String    @map("asset_id")
  dailyRate            Decimal   @db.Decimal(12, 2) @map("daily_rate")
  monthlyRate          Decimal?  @db.Decimal(12, 2) @map("monthly_rate")
  startDate            DateTime  @map("start_date")
  endDate              DateTime? @map("end_date")
  departureDate        DateTime? @map("departure_date") // Data de saída do container — cobrança começa aqui
  returnDate           DateTime? @map("return_date")    // Data de retorno do container
  isActive             Boolean   @default(true) @map("is_active")
  notes                String?
  scheduledDeliveryDate DateTime? @map("scheduled_delivery_date") // Data programada para entrega
  deliveryBlockedReason String?  @map("delivery_blocked_reason")   // PAGAMENTO_PENDENTE | CONTRATO_NAO_ASSINADO = bloqueado
  createdAt            DateTime  @default(now()) @map("created_at")

  contract         Contract          @relation(fields: [contractId], references: [id], onDelete: Cascade)
  asset            Asset             @relation(fields: [assetId], references: [id])
  measurementItems MeasurementItem[]
  invoiceItems     InvoiceItem[]

  @@index([contractId])
  @@map("contract_items")
}

model ContractAddendum {
  id             String       @id @default(uuid())
  contractId     String       @map("contract_id")
  addendumNumber Int          @map("addendum_number")
  type           AddendumType
  description    String
  effectiveDate  DateTime     @map("effective_date")
  notes          String?
  createdAt      DateTime     @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_addendums")
}

enum AddendumType {
  EXTENSION
  ITEM_ADDITION
  ITEM_REMOVAL
  PRICE_ADJUSTMENT
  PARTIAL_CLOSURE
  OTHER
}

model Measurement {
  id          String            @id @default(uuid())
  contractId  String            @map("contract_id")
  periodStart DateTime          @map("period_start")
  periodEnd   DateTime          @map("period_end")
  totalValue  Decimal           @db.Decimal(14, 2) @map("total_value")
  status      MeasurementStatus @default(DRAFT)
  notes       String?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  contract Contract          @relation(fields: [contractId], references: [id], onDelete: Cascade)
  items    MeasurementItem[]
  invoice  Invoice?

  @@index([contractId])
  @@map("measurements")
}

model MeasurementItem {
  id             String  @id @default(uuid())
  measurementId  String  @map("measurement_id")
  contractItemId String  @map("contract_item_id")
  days           Int
  excludedDays   Int     @default(0) @map("excluded_days")
  excludedReason String? @map("excluded_reason") // Motivo de não faturar certos dias
  billedDays     Int?    @map("billed_days")     // Dias efetivamente cobrados
  dailyRate      Decimal @db.Decimal(12, 2) @map("daily_rate")
  totalValue     Decimal @db.Decimal(14, 2) @map("total_value")

  measurement  Measurement  @relation(fields: [measurementId], references: [id], onDelete: Cascade)
  contractItem ContractItem @relation(fields: [contractItemId], references: [id])

  @@map("measurement_items")
}

enum MeasurementStatus {
  DRAFT
  APPROVED
  INVOICED
  CANCELLED
}

model ContractMovement {
  id           String       @id @default(uuid())
  contractId   String       @map("contract_id")
  type         MovementType
  assetCode    String?      @map("asset_code")
  movementDate DateTime     @map("movement_date")
  address      String?
  notes        String?
  createdAt    DateTime     @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_movements")
}

enum MovementType {
  DELIVERY
  PICKUP
  SWAP
  RETIRADA
  REMOCAO
  TROCA_AR
}

// ============================================================
// M5 — FROTA
// ============================================================

model Vehicle {
  id             String        @id @default(uuid())
  companyId      String        @map("company_id")
  plate          String        @unique
  type           String
  brand          String?
  model          String?
  year           Int?
  renavam        String?
  loadCapacityKg Decimal?      @db.Decimal(10, 2) @map("load_capacity_kg")
  currentKm      Int?          @map("current_km")
  status         VehicleStatus @default(AVAILABLE)
  isActive       Boolean       @default(true) @map("is_active")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  deletedAt      DateTime?     @map("deleted_at")

  company         Company              @relation(fields: [companyId], references: [id])
  transportOrders TransportOrder[]
  checklists      VehicleChecklist[]
  fuelRecords     FuelRecord[]
  maintenances    VehicleMaintenance[]

  @@index([companyId])
  @@map("vehicles")
}

enum VehicleStatus {
  AVAILABLE
  IN_OPERATION
  IN_MAINTENANCE
  DECOMMISSIONED
}

model Driver {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  name        String
  cpf         String   @unique
  cnhNumber   String   @map("cnh_number")
  cnhCategory String   @map("cnh_category")
  cnhExpiry   DateTime @map("cnh_expiry")
  phone       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company         Company          @relation(fields: [companyId], references: [id])
  transportOrders TransportOrder[]

  @@index([companyId])
  @@map("drivers")
}

model VehicleChecklist {
  id            String   @id @default(uuid())
  vehicleId     String   @map("vehicle_id")
  checkDate     DateTime @map("check_date")
  checkedBy     String   @map("checked_by")
  items         Json
  overallStatus String   @map("overall_status")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@map("vehicle_checklists")
}

model TransportOrder {
  id            String               @id @default(uuid())
  vehicleId     String?              @map("vehicle_id")
  driverId      String?              @map("driver_id")
  assetId       String?              @map("asset_id")
  requestedBy   String?              @map("requested_by")
  orderNumber   String               @map("order_number")
  type          TransportOrderType
  origin        String
  destination   String
  scheduledDate DateTime             @map("scheduled_date")
  completedDate DateTime?            @map("completed_date")
  status        TransportOrderStatus @default(PENDING)
  notes         String?
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")

  vehicle         Vehicle? @relation(fields: [vehicleId], references: [id])
  driver          Driver?  @relation(fields: [driverId], references: [id])
  asset           Asset?   @relation(fields: [assetId], references: [id])
  requestedByUser User?    @relation(fields: [requestedBy], references: [id])

  @@index([status])
  @@map("transport_orders")
}

enum TransportOrderType {
  DELIVERY
  PICKUP
  TRANSFER
}

enum TransportOrderStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model FuelRecord {
  id        String   @id @default(uuid())
  vehicleId String   @map("vehicle_id")
  date      DateTime
  liters    Decimal  @db.Decimal(10, 2)
  totalCost Decimal  @db.Decimal(12, 2) @map("total_cost")
  currentKm Int      @map("current_km")
  station   String?
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@map("fuel_records")
}

model VehicleMaintenance {
  id            String          @id @default(uuid())
  vehicleId     String          @map("vehicle_id")
  supplierId    String?         @map("supplier_id")
  type          MaintenanceType @default(CORRECTIVE)
  description   String
  cost          Decimal?        @db.Decimal(12, 2)
  currentKm     Int?            @map("current_km")
  startDate     DateTime        @map("start_date")
  endDate       DateTime?       @map("end_date")
  partsReplaced String?         @map("parts_replaced")
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  vehicle  Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@index([vehicleId])
  @@map("vehicle_maintenances")
}

// ============================================================
// M6 — COBRANÇA
// ============================================================

model Invoice {
  id                 String        @id @default(uuid())
  companyId          String        @map("company_id")
  customerId         String        @map("customer_id")
  contractId         String?       @map("contract_id")
  measurementId      String?       @unique @map("measurement_id")
  invoiceNumber      String        @map("invoice_number")
  issueDate          DateTime      @map("issue_date")
  dueDate            DateTime      @map("due_date")
  billingPeriodStart DateTime?     @map("billing_period_start") // Período de faturamento
  billingPeriodEnd   DateTime?     @map("billing_period_end")
  amount             Decimal       @db.Decimal(14, 2)
  paidAmount         Decimal       @default(0) @db.Decimal(14, 2) @map("paid_amount")
  status             InvoiceStatus @default(OPEN)
  notes              String?
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  company           Company            @relation(fields: [companyId], references: [id])
  customer          Customer           @relation(fields: [customerId], references: [id])
  contract          Contract?          @relation(fields: [contractId], references: [id])
  measurement       Measurement?       @relation(fields: [measurementId], references: [id])
  payments          InvoicePayment[]
  collectionActions CollectionAction[]
  items             InvoiceItem[]

  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// Item de fatura — cada container faturado de um contrato
model InvoiceItem {
  id               String   @id @default(uuid())
  invoiceId        String   @map("invoice_id")
  contractItemId   String   @map("contract_item_id")
  assetCode        String   @map("asset_code")
  periodStart      DateTime @map("period_start")
  periodEnd        DateTime @map("period_end")
  totalDays        Int      @map("total_days")
  excludedDays     Int      @default(0) @map("excluded_days")
  excludedReason   String?  @map("excluded_reason")
  billedDays       Int      @map("billed_days")
  dailyRate        Decimal  @db.Decimal(12, 2) @map("daily_rate")
  totalValue       Decimal  @db.Decimal(14, 2) @map("total_value")

  invoice      Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  contractItem ContractItem @relation(fields: [contractItemId], references: [id])

  @@index([invoiceId])
  @@map("invoice_items")
}

enum InvoiceStatus {
  OPEN
  PAID
  PARTIALLY_PAID
  OVERDUE
  IN_AGREEMENT
  CANCELLED
  WRITTEN_OFF
}

model InvoicePayment {
  id            String   @id @default(uuid())
  invoiceId     String   @map("invoice_id")
  paymentDate   DateTime @map("payment_date")
  amount        Decimal  @db.Decimal(14, 2)
  paymentMethod String?  @map("payment_method")
  bankAccount   String?  @map("bank_account")
  reference     String?
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_payments")
}

model DefaulterRecord {
  id         String    @id @default(uuid())
  customerId String    @map("customer_id")
  startDate  DateTime  @map("start_date")
  endDate    DateTime? @map("end_date")
  totalDebt  Decimal   @db.Decimal(14, 2) @map("total_debt")
  reason     String?
  isResolved Boolean   @default(false) @map("is_resolved")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  customer  Customer          @relation(fields: [customerId], references: [id])
  agreement PaymentAgreement?

  @@index([customerId])
  @@map("defaulter_records")
}

model CollectionAction {
  id             String               @id @default(uuid())
  invoiceId      String               @map("invoice_id")
  performedById  String?              @map("performed_by_id")
  type           CollectionActionType
  actionDate     DateTime             @map("action_date")
  description    String?
  result         String?
  nextActionDate DateTime?            @map("next_action_date")
  createdAt      DateTime             @default(now()) @map("created_at")

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  performedBy User?   @relation(fields: [performedById], references: [id])

  @@index([invoiceId])
  @@map("collection_actions")
}

enum CollectionActionType {
  PHONE_CALL
  EMAIL
  LETTER
  PROTEST
  LEGAL
  VISIT
  OTHER
}

model PaymentAgreement {
  id                String          @id @default(uuid())
  defaulterRecordId String          @unique @map("defaulter_record_id")
  agreementDate     DateTime        @map("agreement_date")
  originalDebt      Decimal         @db.Decimal(14, 2) @map("original_debt")
  discountPercent   Decimal?        @db.Decimal(5, 2) @map("discount_percent")
  finalAmount       Decimal         @db.Decimal(14, 2) @map("final_amount")
  installments      Int
  notes             String?
  status            AgreementStatus @default(ACTIVE)
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  defaulterRecord DefaulterRecord @relation(fields: [defaulterRecordId], references: [id])

  @@map("payment_agreements")
}

enum AgreementStatus {
  ACTIVE
  COMPLETED
  BROKEN
  CANCELLED
}

model Bidding {
  id             String        @id @default(uuid())
  companyId      String        @map("company_id")
  biddingNumber  String        @map("bidding_number")
  title          String
  description    String?
  openingDate    DateTime      @map("opening_date")
  closingDate    DateTime?     @map("closing_date")
  estimatedValue Decimal?      @db.Decimal(14, 2) @map("estimated_value")
  status         BiddingStatus @default(OPEN)
  requiredDocs   String?       @map("required_docs")
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("biddings")
}

enum BiddingStatus {
  OPEN
  IN_ANALYSIS
  WON
  LOST
  CANCELLED
}

// ============================================================
// PROPOSTAS
// ============================================================

model Proposal {
  id             String        @id @default(uuid())
  companyId      String        @map("company_id")
  customerId     String?       @map("customer_id")
  proposalNumber String        @map("proposal_number")
  type           ProposalType  @default(LOCACAO)
  status         ProposalStatus @default(RASCUNHO)
  items          Json          @default("[]")
  valorTotal     Decimal       @db.Decimal(14, 2) @map("valor_total")
  companyName    String?       @map("company_name")
  contactName    String?       @map("contact_name")
  phone          String?
  email          String?
  contractId     String?       @map("contract_id")
  invoiceId      String?       @map("invoice_id")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])

  @@unique([companyId, proposalNumber])
  @@index([companyId])
  @@index([status])
  @@map("proposals")
}

enum ProposalType {
  VENDA
  LOCACAO
  EVENTO
}

enum ProposalStatus {
  RASCUNHO
  ENVIADA
  ACEITA
  RECUSADA
  CONVERTIDA
}

// ============================================================
// ANÁLISE CRÍTICA, DOCUMENTO AF, ORDEM DE SERVIÇO
// ============================================================

model ContractAnalysis {
  id              String   @id @default(uuid())
  contractId      String   @map("contract_id")
  proposalNumber String?  @map("proposal_number")
  proposalDate   DateTime? @map("proposal_date")
  customerName   String?  @map("customer_name")
  cnpj           String?
  addressCnpj    String?  @map("address_cnpj")
  addressInstall  String? @map("address_install")
  contactComercial String? @map("contact_comercial")
  contactFinanceiro String? @map("contact_financeiro")
  contactRecebimento String? @map("contact_recebimento")
  responsible    String?
  witness        String?
  equipmentModels String? @map("equipment_models")
  monthlyValue   Decimal? @db.Decimal(14, 2) @map("monthly_value")
  monthsRental   Int?     @map("months_rental")
  expectedExit   DateTime? @map("expected_exit")
  extraData      Json?    @map("extra_data")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_analyses")
}

model SupplyOrder {
  id              String   @id @default(uuid())
  contractId      String   @map("contract_id")
  supplyNumber    String   @map("supply_number")
  customerName   String?  @map("customer_name")
  mobilization   Boolean  @default(false)
  equipmentCount  Int?    @map("equipment_count")
  deliveryDate    DateTime? @map("delivery_date")
  layoutNotes    String?  @map("layout_notes")
  technicalNotes  String?  @map("technical_notes")
  createdAt      DateTime @default(now()) @map("created_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, supplyNumber])
  @@index([contractId])
  @@map("supply_orders")
}

model ServiceOrder {
  id           String        @id @default(uuid())
  companyId    String        @map("company_id")
  contractId   String        @map("contract_id")
  orderNumber  String        @map("order_number")
  type         ServiceOrderType
  address      String?
  addressTo    String?       @map("address_to")
  phone        String?
  scheduledDate DateTime?    @map("scheduled_date")
  freightValue Decimal?      @db.Decimal(14, 2) @map("freight_value")
  extraTax     Decimal?      @db.Decimal(14, 2) @map("extra_tax")
  notes        String?
  status       ServiceOrderStatus @default(PENDING)
  emitNf       Boolean       @default(true) @map("emit_nf")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  company  Company  @relation(fields: [companyId], references: [id])
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([companyId, orderNumber])
  @@index([contractId])
  @@index([companyId])
  @@map("service_orders")
}

enum ServiceOrderType {
  INSTALACAO
  RETIRADA
  REMOCAO
  TROCA_AR
  MANUTENCAO
}

enum ServiceOrderStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
